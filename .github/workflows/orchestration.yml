name: Deployment Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target_environment:
        type: choice
        description: 'Deploy to environment'
        options:
          - dev
          - qa
          - prod
      skip_dev:
        type: boolean
        description: 'Skip DEV deployment'
        default: false

jobs:
  define_version:  
    runs-on: ubuntu-latest
    steps:
      - name: Build Application
        run: |
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          SHORT_SHA=$(git rev-parse --short=8 HEAD)
          IMAGE_TAG="${SHORT_SHA}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  ci:
    needs: define_version
    uses: ./.github/workflows/ci.yml
    with:
      version: ${{ needs.define_version.outputs.version }}
      image_tag: ${{ needs.define_version.outputs.image_tag }}
    
  deploy-dev:
    needs: [define_version,ci]
    if: github.event.inputs.skip_dev != 'true'
    uses: ./.github/workflows/cd.yml
    with:
      environment: dev
      version: ${{ needs.define_version.outputs.version }}
      image_tag: ${{ needs.define_version.outputs.image_tag }}
    secrets: inherit          

  deploy-qa:
    needs: [define_version,ci, deploy-dev]
    if: |
      always() && 
      (needs.deploy-dev.result == 'success' || github.event.inputs.skip_dev == 'true')
    uses: ./.github/workflows/cd.yml
    with:
      environment: qa
      version: ${{ needs.define_version.outputs.version }}
      image_tag: ${{ needs.define_version.outputs.image_tag }}
    secrets: inherit